---
title: "Homework 5"
author: "Tongtong Zhu"
date: "2022-11-12"
output: github_document
---

```{r setup, include = FALSE, message = FALSE, warning = FALSE}
library(tidyverse)

knitr::opts_chunk$set(
	echo = TRUE,
	warning = FALSE,
  fig.width = 6,
  fig.asp = .6,
  out.width = "90%"
)
theme_set(theme_minimal() + theme(legend.position = "bottom"))
options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)
scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d

set.seed(1)
```


## Problem 1

### Create a tidy dataframe and manipulate

```{r,show_col_types = FALSE}
longi_df =
  tibble(
    file = list.files("data")) %>% 
  mutate(
    path = str_c("data/", file),
    data = purrr::map(.x = path, ~read_csv(.x))) %>% 
  unnest(data) %>% 
  mutate(id = str_extract(file, "\\d+"),
         id = as.numeric(id),
         arm = str_extract(file, "con|exp")) %>% 
  relocate(id, arm, path,everything()) %>% 
  mutate(arm = recode(arm, con = "control", exp = "experimental")) %>% 
  pivot_longer(
    week_1:week_8,
    names_to = "week",
    names_prefix = "week_",
    values_to = "observation"
  )
```

### Make a spaghetti plot

```{r}
longi_df %>% 
  ggplot(aes(x = week, y = observation, group = id, color = arm)) +
  geom_path() +
  labs(
      x = "Week",
      y = "Observation",
      title = "Observations for subjects in experimental and control groups for each week"
      )
```

**Comment on difference**

In general, the observation values of the experimental group continue to increase, while the observation values of the control group are relatively stable over time. On average, the observation values of the experimental group are higher than those of the control group. The difference of observations between two groups gradually increases from week 2.

## Problem 2

### Describe the raw data

```{r, message = FALSE}
homicide_raw = read_csv("./data_homi/homicide-data.csv")
```

The `homicide_raw` dataset contains information collected by the *Washington Post* on criminal homicides over the past decade in 50 of the largest US cities. It contains `r nrow(homicide_raw)` observations and `r ncol(homicide_raw)` variables. The key variables include `r colnames(homicide_raw)`.

### Create `city_state` and `resolution` variables 

```{r}
homicide_df =
  homicide_raw %>% 
  mutate(
    city_state = str_c(city, state, sep = ", "),
    city_state = recode(city_state, "Tulsa, AL" = "Tulsa, OK"),
    resolved = case_when(
      disposition == "Closed without arrest" ~ "unsolved",
      disposition == "Open/No arrest"        ~ "unsolved",
      disposition == "Closed by arrest"      ~ "solved"
    )) %>% 
  relocate(city_state)
      
```

### Summarize total No. of homicides and unsolved homicides within cities

```{r}
homi_summary =
  homicide_df %>% 
  group_by(city_state) %>% 
  summarize(
    total_homi = n(),
    homi_unsolved = sum(resolved == "unsolved")
  )

homi_summary
```

### Estimate the proportion of unsolved homicides for Baltimore

```{r}
balt_prop = 
  prop.test(
    x = homi_summary %>% filter(city_state == "Baltimore, MD") %>% pull(homi_unsolved),
    n = homi_summary %>% filter(city_state == "Baltimore, MD") %>% pull(total_homi)
  )  

balt_prop %>% 
  broom::tidy() %>% 
  select(estimate, conf.low, conf.high)
```

